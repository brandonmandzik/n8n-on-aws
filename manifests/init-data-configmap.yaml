apiVersion: v1
kind: ConfigMap
metadata:
  name: init-data
  namespace: n8n
data:
  init-data.sh: |
    #!/bin/bash
    set -e

    # Enable pgcrypto extension for gen_random_uuid()
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        CREATE EXTENSION IF NOT EXISTS pgcrypto;
    EOSQL

    # Create non-root user if POSTGRES_NON_ROOT_USER is set
    if [ -n "$POSTGRES_NON_ROOT_USER" ]; then
      psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        CREATE USER "$POSTGRES_NON_ROOT_USER" WITH PASSWORD '$POSTGRES_NON_ROOT_PASSWORD';
        GRANT ALL PRIVILEGES ON DATABASE "$POSTGRES_DB" TO "$POSTGRES_NON_ROOT_USER";
        ALTER DATABASE "$POSTGRES_DB" OWNER TO "$POSTGRES_NON_ROOT_USER";
    EOSQL
    fi
